---
title: "graphics_tables"
author: "Leandro Pereira Garcia"
date: "November, 2020"
output: 
  word_document: 
    reference_docx: paper.docx
    fig_caption: yes
    fig_height: 8
    fig_width: 12
    toc: no
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
options(scipen=999)
set.seed(233)
```


```{r include=FALSE}
#Libraries
library(readr)
library(tidyverse)
library(ggplot2)
library(sf)
library(spData)
library(ggpubr)
library(RColorBrewer)
library(corrplot)
library(ggcorrplot)
library(reshape2)
```


```{r include=FALSE}
#Databases
base_efi <- read_csv("bases/completed_base.csv")

base_efi$gdp_range <- ifelse(base_efi$GDP_PER_CAP_LAGGED < quantile(base_efi$GDP_PER_CAP_LAGGED,0.5),"under", "over")

base_efi_under <- subset(base_efi, base_efi$gdp_range == "under")
base_efi_over <- subset(base_efi, base_efi$gdp_range == "over")

impact_under <- read_csv("bases/impact_under.csv")
impact_over <- read_csv("bases/impact_over.csv")

impact_result <- rbind(impact_under,
		       impact_over) %>% as.data.frame()

```

```{r echo=TRUE}
#Description
base_efi_under[which(base_efi_under$MEAN_RATE_NEO == min(base_efi_under$MEAN_RATE_NEO, na.rm = T)), colnames(base_efi_under) %in% c("LOCATION", "MEAN_RATE_NEO")]
base_efi_under[which(base_efi_under$MEAN_RATE_NEO == max(base_efi_under$MEAN_RATE_NEO, na.rm = T)), colnames(base_efi_under) %in% c("LOCATION", "MEAN_RATE_NEO")]
```

```{r echo=TRUE}
base_efi_under[which(base_efi_under$MEAN_RATE_NEO_U5 == min(base_efi_under$MEAN_RATE_NEO_U5, na.rm = T)), colnames(base_efi_under) %in% c("LOCATION", "MEAN_RATE_NEO_U5")]
base_efi_under[which(base_efi_under$MEAN_RATE_NEO_U5 == max(base_efi_under$MEAN_RATE_NEO_U5, na.rm = T)), colnames(base_efi_under) %in% c("LOCATION", "MEAN_RATE_NEO_U5")]
```

```{r echo=TRUE}
base_efi_under[which(base_efi_under$PUBLIC_EXP_PER_CAP_LAGGED == min(base_efi_under$PUBLIC_EXP_PER_CAP_LAGGED, na.rm = T)), colnames(base_efi_under) %in% c("LOCATION", "PUBLIC_EXP_PER_CAP_LAGGED")]
base_efi_under[which(base_efi_under$PUBLIC_EXP_PER_CAP_LAGGED == max(base_efi_under$PUBLIC_EXP_PER_CAP_LAGGED, na.rm = T)), colnames(base_efi_under) %in% c("LOCATION", "PUBLIC_EXP_PER_CAP_LAGGED")]
```

```{r echo=TRUE}
base_efi_under[which(base_efi_under$HEALTH_EXP_LAGGED == min(base_efi_under$HEALTH_EXP_LAGGED, na.rm = T)), colnames(base_efi_under) %in% c("LOCATION", "HEALTH_EXP_LAGGED")]
base_efi_under[which(base_efi_under$HEALTH_EXP_LAGGED == max(base_efi_under$HEALTH_EXP_LAGGED, na.rm = T)), colnames(base_efi_under) %in% c("LOCATION", "HEALTH_EXP_LAGGED")]
```

```{r echo=TRUE}
base_efi_under[which(base_efi_under$OTHER_EXP_LAGGED == min(base_efi_under$OTHER_EXP_LAGGED, na.rm = T)), colnames(base_efi_under) %in% c("LOCATION", "OTHER_EXP_LAGGED")]
base_efi_under[which(base_efi_under$OTHER_EXP_LAGGED == max(base_efi_under$OTHER_EXP_LAGGED, na.rm = T)), colnames(base_efi_under) %in% c("LOCATION", "OTHER_EXP_LAGGED")]
```







```{r echo=TRUE}
#Description
base_efi_over[which(base_efi_over$MEAN_RATE_NEO == min(base_efi_over$MEAN_RATE_NEO, na.rm = T)), colnames(base_efi_over) %in% c("LOCATION", "MEAN_RATE_NEO")]
base_efi_over[which(base_efi_over$MEAN_RATE_NEO == max(base_efi_over$MEAN_RATE_NEO, na.rm = T)), colnames(base_efi_over) %in% c("LOCATION", "MEAN_RATE_NEO")]
```

```{r echo=TRUE}
base_efi_over[which(base_efi_over$MEAN_RATE_NEO_U5 == min(base_efi_over$MEAN_RATE_NEO_U5, na.rm = T)), colnames(base_efi_over) %in% c("LOCATION", "MEAN_RATE_NEO_U5")]
base_efi_over[which(base_efi_over$MEAN_RATE_NEO_U5 == max(base_efi_over$MEAN_RATE_NEO_U5, na.rm = T)), colnames(base_efi_over) %in% c("LOCATION", "MEAN_RATE_NEO_U5")]
```

```{r echo=TRUE}
base_efi_over[which(base_efi_over$PUBLIC_EXP_PER_CAP_LAGGED == min(base_efi_over$PUBLIC_EXP_PER_CAP_LAGGED, na.rm = T)), colnames(base_efi_over) %in% c("LOCATION", "PUBLIC_EXP_PER_CAP_LAGGED")]
base_efi_over[which(base_efi_over$PUBLIC_EXP_PER_CAP_LAGGED == max(base_efi_over$PUBLIC_EXP_PER_CAP_LAGGED, na.rm = T)), colnames(base_efi_over) %in% c("LOCATION", "PUBLIC_EXP_PER_CAP_LAGGED")]
```

```{r echo=TRUE}
base_efi_over[which(base_efi_over$HEALTH_EXP_LAGGED == min(base_efi_over$HEALTH_EXP_LAGGED, na.rm = T)), colnames(base_efi_over) %in% c("LOCATION", "HEALTH_EXP_LAGGED")]
base_efi_over[which(base_efi_over$HEALTH_EXP_LAGGED == max(base_efi_over$HEALTH_EXP_LAGGED, na.rm = T)), colnames(base_efi_over) %in% c("LOCATION", "HEALTH_EXP_LAGGED")]
```

```{r echo=TRUE}
base_efi_over[which(base_efi_over$OTHER_EXP_LAGGED == min(base_efi_over$OTHER_EXP_LAGGED, na.rm = T)), colnames(base_efi_over) %in% c("LOCATION", "OTHER_EXP_LAGGED")]
base_efi_over[which(base_efi_over$OTHER_EXP_LAGGED == max(base_efi_over$OTHER_EXP_LAGGED, na.rm = T)), colnames(base_efi_over) %in% c("LOCATION", "OTHER_EXP_LAGGED")]
```














```{r include=FALSE}
#Importing the world map
WorldData <- map_data('world')
countries_world <- data.frame(WORLD = WorldData$region) 
WorldData %>% filter(region != "Antarctica") -> WorldData
WorldData <- fortify(WorldData)


base_efi_loc <- data.frame(BASE_EFI_COUNTRIES = unique(base_efi$LOCATION),
			    BASE_EFI_COUNTRIES_2 = unique(base_efi$LOCATION))
	
countries <- merge(countries_world, base_efi_loc, by.x = "WORLD", by.y = "BASE_EFI_COUNTRIES_2", all = T) %>% unique()


base_efi[which(base_efi$LOCATION == "Bolivia (Plurinational State of)"), 1] <- "Bolivia"
base_efi[which(base_efi$LOCATION == "Czechia"), 1] <- "Czech Republic"
base_efi[which(base_efi$LOCATION == "Iran (Islamic Republic of)"), 1] <- "Iran"
base_efi[which(base_efi$LOCATION == "Lao People's Democratic Republic"), 1] <- "Laos"
base_efi[which(base_efi$LOCATION == "Democratic People's Republic of Korea"), 1] <- "North Korea"
base_efi[which(base_efi$LOCATION == "Congo"), 1] <- "Republic of Congo"
base_efi[which(base_efi$LOCATION == "Russian Federation"), 1] <- "Russia"
base_efi[which(base_efi$LOCATION == "United Republic of Tanzania"), 1] <- "Tanzania"
base_efi[which(base_efi$LOCATION == "United Kingdom"), 1] <- "UK"
base_efi[which(base_efi$LOCATION == "United States of America"), 1] <- "USA"
base_efi[which(base_efi$LOCATION == "Venezuela (Bolivarian Republic of)"), 1] <- "Venezuela"
base_efi[which(base_efi$LOCATION == "Viet Nam"), 1] <- "Vietnam"
base_efi[which(base_efi$LOCATION == ""), 1] <- ""


base_map <- base_efi
base_map <- merge(base_map, WorldData, by.x = "LOCATION", by.y = "region", all.x = T)

base_map_under <- subset(base_map, base_map$gdp_range == "under")
base_map_over <- subset(base_map, base_map$gdp_range == "over")

```

```{r include=FALSE}

myPalette_rev <- colorRampPalette(brewer.pal(11, "Spectral")) #Increasing
myPalette <- colorRampPalette(rev(brewer.pal(11, "Spectral")))  #Decreasing

```



```{r fig.width=20, fig.height=9}
#Mortality

plot1 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=base_map_under, map=WorldData,
                  aes(fill= MEAN_RATE_NEO, map_id=LOCATION),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Mean NeoRt 2018-2019", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette(20), 
                             labels = round(quantile(base_map_under$MEAN_RATE_NEO, c(.05,.95)),2), 
                             breaks = round(quantile(base_map_under$MEAN_RATE_NEO, c(.05,.95)),2))



plot2 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=base_map_under, map=WorldData,
                  aes(fill= MEAN_RATE_NEO_U5, map_id=LOCATION),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Mean NeoU5Rt 2018-2019", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette(20), 
                             labels = round(quantile(base_map_under$MEAN_RATE_NEO_U5, c(.05,.95)),2), 
                             breaks = round(quantile(base_map_under$MEAN_RATE_NEO_U5, c(.05,.95)),2))

plot3 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=base_map_over, map=WorldData,
                  aes(fill= MEAN_RATE_NEO, map_id=LOCATION),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Mean NeoRt 2018-2019", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette(20), 
                             labels = round(quantile(base_map_over$MEAN_RATE_NEO, c(.05,.95)),2), 
                             breaks = round(quantile(base_map_over$MEAN_RATE_NEO, c(.05,.95)),2))



plot4 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=base_map_over, map=WorldData,
                  aes(fill= MEAN_RATE_NEO_U5, map_id=LOCATION),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Mean NeoU5Rt 2018-2019", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette(20), 
                             labels = round(quantile(base_map_over$MEAN_RATE_NEO_U5, c(.05,.95)),2), 
                             breaks = round(quantile(base_map_over$MEAN_RATE_NEO_U5, c(.05,.95)),2))


plot5 <- ggarrange(plot1, plot2, labels = c("A", "B"), ncol = 1, nrow = 2,
           common.legend = F,legend = "bottom")
plot6 <- ggarrange(plot3, plot4, labels = c("C", "D"), ncol = 1, nrow = 2,
           common.legend = F,legend = "bottom")
ggarrange(plot5, plot6, ncol = 2,nrow = 1,
           common.legend = F,legend = "bottom")

```


```{r fig.width=16, fig.height=10}
#Treatment

plot1 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=base_map_under, map=WorldData,
                  aes(fill= LOG_PUBLIC_EXP_PER_CAP_LAGGED, map_id=LOCATION),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Log of Mean Total Public Exp 2013-2017", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette_rev(20), 
                             labels = round(quantile(base_map_under$LOG_PUBLIC_EXP_PER_CAP_LAGGED, c(.05,.95)),2), 
                             breaks = round(quantile(base_map_under$LOG_PUBLIC_EXP_PER_CAP_LAGGED, c(.05,.95)),2))



plot2 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=base_map_under, map=WorldData,
                  aes(fill= LOG_HEALTH_EXP_LAGGED, map_id=LOCATION),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Log of Mean Health Public Exp 2013-2017", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette_rev(20), 
                             labels = round(quantile(base_map_under$LOG_HEALTH_EXP_LAGGED, c(.05,.95)),2), 
                             breaks = round(quantile(base_map_under$LOG_HEALTH_EXP_LAGGED, c(.05,.95)),2))

plot3 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=base_map_under, map=WorldData,
                  aes(fill= LOG_OTHER_EXP_LAGGED, map_id=LOCATION),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Log of Mean Other Sec Public Exp 2013-2017", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette_rev(20), 
                             labels = round(quantile(base_map_under$LOG_OTHER_EXP_LAGGED, c(.05,.95)),2), 
                             breaks = round(quantile(base_map_under$LOG_OTHER_EXP_LAGGED, c(.05,.95)),2))

plot4 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=base_map_over, map=WorldData,
                  aes(fill= LOG_PUBLIC_EXP_PER_CAP_LAGGED, map_id=LOCATION),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Log of Mean Total Public Exp 2013-2017", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette_rev(20), 
                             labels = round(quantile(base_map_over$LOG_PUBLIC_EXP_PER_CAP_LAGGED, c(.05,.95)),2), 
                             breaks = round(quantile(base_map_over$LOG_PUBLIC_EXP_PER_CAP_LAGGED, c(.05,.95)),2))



plot5 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=base_map_over, map=WorldData,
                  aes(fill= LOG_HEALTH_EXP_LAGGED, map_id=LOCATION),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Log of Mean Health Public Exp 2013-2017", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette_rev(20), 
                             labels = round(quantile(base_map_over$LOG_HEALTH_EXP_LAGGED, c(.05,.95)),2), 
                             breaks = round(quantile(base_map_over$LOG_HEALTH_EXP_LAGGED, c(.05,.95)),2))

plot6 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=base_map_over, map=WorldData,
                  aes(fill= LOG_OTHER_EXP_LAGGED, map_id=LOCATION),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Log of Mean Other Sec Public Exp 2013-2017", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette_rev(20), 
                             labels = round(quantile(base_map_over$LOG_OTHER_EXP_LAGGED, c(.05,.95)),2), 
                             breaks = round(quantile(base_map_over$LOG_OTHER_EXP_LAGGED, c(.05,.95)),2))



plot7 <- ggarrange(plot1, plot2, plot3, labels = c("A", "B", "C"),  ncol = 1,nrow = 3,common.legend = F, legend = "bottom")
plot8 <- ggarrange(plot4, plot5, plot6, labels = c("D", "E", "F"),  ncol = 1,nrow = 3,common.legend = F, legend = "bottom")
ggarrange(plot7, plot8,  ncol = 2,nrow = 1,common.legend = F, legend = "bottom")

```



```{r fig.width=12, fig.height=12}
impact_result_table <- impact_result
impact_result_table$Est. <- round(impact_result_table$Est., 3) 
impact_result_table$`2.5%` <- round(impact_result_table$`2.5%`, 3) 
impact_result_table$`97.5%` <- round(impact_result_table$`97.5%`, 3) 
impact_result_table$CI <-  paste0("(",impact_result_table$`2.5%`,", ", impact_result_table$`97.5%`,")")
impact_result_table$"Impact\n(CI95%)" <- paste0(impact_result_table$Est., impact_result_table$CI, sep="\n")
impact_result_table$Est. <- NULL
impact_result_table$`2.5%` <- NULL
impact_result_table$`97.5%` <- NULL
impact_result_table$CI <- NULL
names(impact_result_table) <- c("Treatment", "Mortality rate", "Group - GDP Rage", "Impact\n(CI95%)")
impact_result_table <- impact_result_table %>% dplyr::select("Group - GDP Rage","Treatment", "Mortality rate","Impact\n(CI95%)")
write.csv(impact_result_table, "bases/impact_result_table.csv", row.names = F)

```




